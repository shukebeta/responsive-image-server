server {
    server_name 127.0.0.1;
    listen 8888;

    # The new section you can copy/paste in
    location ~ "^/(?<width>\d+)/(?<image>.+)$" {
        alias /files/$image;
        image_filter resize $width -;
        image_filter_jpeg_quality 75;
        image_filter_buffer 20M;
    }
}

proxy_cache_path /nginx-images-cache/ levels=1:2 keys_zone=images:10m inactive=48h max_size=10240m;

server {
  server_name localhost;
  listen 80;

  # Whatever other rules your server has are here
  # Like certs, other locations, etc.

  # Pass requests to your resizing server
  location ~ "^/(?<width>\d+)/(?<image>.+)$" {
    expires 1y;
    add_header Cache-Control "public, no-transform";
    proxy_pass http://127.0.0.1:8888/$width/$image;
    proxy_cache images;
    proxy_cache_valid 200 48h;
  }

  # I got this from one of the tutorials, apparently it helps avoid the error
  # "no resolver defined to resolve 127.0.0.1"
  location /image {
    proxy_pass http://127.0.0.1:8888/;
  }
  #include /etc/nginx/conf.d/snippets/ssl.conf;
}

# Reference:https://monicalent.com/blog/2019/01/06/responsive-images-with-nginx/
